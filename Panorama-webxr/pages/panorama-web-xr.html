<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
		<title>Dual Cylinder Projection</title>
		<link type="text/css" rel="stylesheet" href="main.css" />
	</head>
	<body>
		<!-- <script src="../../THREE116/examples/js/HelioWebXRPolyfill.js"></script> -->
		<script type="module">
			// three.js revision 116
			// 启用webXR的几个步骤
			// 1. import VRButton
			// 2. document.body.appendChild( VRButton.createButton( renderer ) )
			// 3. renderer.xr.enabled = true
			// 4. 使用serAnimationLoop 代替 window.requestAnimationFrame
			
			import * as THREE from '../../THREE116/build/three.module.js';
			import {VRButton} from '../../THREE116/examples/jsm/webxr/VRButton.js';
			import {OBJLoader} from '../../THREE116/examples/jsm/loaders/OBJLoader.js';
			
			var camera, renderer, scene;
			var materialL, materialR;
			var sourceObj;
			var meshL, meshR;
			
			init();
			
			function loadResources(){
				var manager = new THREE.LoadingManager();
				
				manager.onProgress = function(item, loaded, total) {		
					console.log(item, loaded, total);		
				};
				
				manager.onLoad = function(){
					
					// resources already loaded
					
					meshL = sourceObj.clone();
					meshR = sourceObj.clone();
					
					meshL.material = materialL;
					meshR.material = materialR;
					
					meshL.layers.set(1);
					meshR.layers.set(2);
					
					scene.add(meshL);
					scene.add(meshR);
					
					animate();
				};
				
				manager.onError = function(url){
					console.log( 'There was an error loading ' + url );
				}
				
				var textureLoader = new THREE.TextureLoader(manager);
				var objLoader = new OBJLoader(manager);
				
				textureLoader.load("../resources/textures/Map_v1_step1_28_1Right.jpg",function(texture){
					materialL = new THREE.MeshBasicMaterial({map:texture});
				});
				
				textureLoader.load("../resources/textures/Map_v1_step1_28_1Left.jpg",function(texture){
					materialR = new THREE.MeshBasicMaterial({map:texture});
				});
				
				objLoader.load('../resources/models/dualcylinder.obj',function(obj){
					sourceObj = obj.children[0];
				});
			}
			
			function init() {
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.xr.enabled = true;
				renderer.xr.setReferenceSpaceType( 'local' );
				document.body.appendChild( renderer.domElement );

				document.body.appendChild( VRButton.createButton( renderer ) );

				//

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.layers.enable( 1 );

				loadResources();

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				renderer.setAnimationLoop( render );

			}

			function render() {

				renderer.render( scene, camera );

			}
		</script>
	</body>
</html>
